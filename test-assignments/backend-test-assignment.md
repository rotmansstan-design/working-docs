# Тестовое задание: Backend Developer (Go + PostgreSQL)

## Формат и цель

Это короткое тестовое на **2-3 часа**.  
Проверяем инженерное мышление: консистентность, идемпотентность, качество решений и аргументацию.

## Контекст

Есть пользовательский баланс. Нужно реализовать создание заявки на вывод средств так, чтобы избежать дублей и двойного списания.

## Core (обязательно, 2-3 часа)

### 1) API

Реализовать:
- `POST /v1/withdrawals`
- `GET /v1/withdrawals/{id}`

### 2) Create withdrawal

`POST /v1/withdrawals` принимает:
- `user_id`;
- `amount` (> 0);
- `currency` (`USDT`);
- `destination`;
- `idempotency_key` (обязательный).

Ожидаемое поведение:
- `amount <= 0` -> `400`;
- недостаточный баланс -> `409`;
- тот же `idempotency_key` + тот же payload -> вернуть исходный результат без дубля;
- тот же `idempotency_key` + другой payload -> `422`;
- при успехе создается withdrawal со статусом `pending`.

### 3) Консистентность

Нужно исключить двойное списание при конкурентных запросах на один баланс.

Требования:
- использовать транзакции PostgreSQL;
- описать в README, чем обеспечивается корректность (например, блокировки/ограничения).

### 4) Минимум по безопасности

- базовая auth-проверка (например, фиксированный Bearer token из env);
- валидация входных данных;
- без утечки внутренних ошибок в API-ответ.

### 5) Что сдать

- исходный код;
- SQL-миграции (или `schema.sql`);
- `README.md` (как запустить + ключевые решения);
- тесты.

### 6) Минимальные тесты

- 2 unit/integration теста на create (успех + ошибка);
- 1 тест на идемпотентность;
- 1 конкурентный тест (параллельные create на один баланс).

## Optional (по желанию, +1-2 часа)

- `POST /v1/withdrawals/{id}/confirm`;
- простой ledger (`ledger_entries`);
- структурные логи create/fail/confirm;
- дополнительные edge-case тесты.

## Технические ограничения

- Go 1.22+;
- PostgreSQL 14+;
- REST API;
- Docker Compose для локального запуска.

## Что можно упростить

- один пользователь;
- одна валюта (`USDT`);
- без реальных платежных/крипто-интеграций.
