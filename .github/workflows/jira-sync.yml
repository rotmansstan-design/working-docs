name: Jira Sync

on:
  pull_request:
    types: [opened, reopened, synchronize]
  push:
    branches: [main, dev]

jobs:
  # При открытии PR — переводим тикет в "Код-ревью"
  pr-to-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Extract Jira ticket from branch
        id: ticket
        run: |
          BRANCH="${{ github.head_ref }}"
          TICKET=$(echo "$BRANCH" | grep -oP 'CCAS-\d+' | head -1)
          echo "ticket=$TICKET" >> $GITHUB_OUTPUT
          echo "Found ticket: $TICKET"

      - name: Get transition ID for Код-ревью
        if: steps.ticket.outputs.ticket != ''
        id: transition
        run: |
          TRANSITIONS=$(curl -s \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_TOKEN }}" \
            -H "Accept: application/json" \
            "https://cccasess.atlassian.net/rest/api/3/issue/${{ steps.ticket.outputs.ticket }}/transitions")
          TRANSITION_ID=$(echo "$TRANSITIONS" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for t in data.get('transitions', []):
              if 'ревью' in t['name'].lower() or 'review' in t['name'].lower():
                  print(t['id'])
                  break
          ")
          echo "transition_id=$TRANSITION_ID" >> $GITHUB_OUTPUT

      - name: Move ticket to Код-ревью
        if: steps.ticket.outputs.ticket != '' && steps.transition.outputs.transition_id != ''
        run: |
          curl -s -X POST \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://cccasess.atlassian.net/rest/api/3/issue/${{ steps.ticket.outputs.ticket }}/transitions" \
            -d "{\"transition\": {\"id\": \"${{ steps.transition.outputs.transition_id }}\"}}"
          echo "Moved ${{ steps.ticket.outputs.ticket }} to Код-ревью"

      - name: Add PR link comment to Jira
        if: steps.ticket.outputs.ticket != ''
        run: |
          curl -s -X POST \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://cccasess.atlassian.net/rest/api/3/issue/${{ steps.ticket.outputs.ticket }}/comment" \
            -d "{
              \"body\": {
                \"type\": \"doc\",
                \"version\": 1,
                \"content\": [{
                  \"type\": \"paragraph\",
                  \"content\": [{
                    \"type\": \"text\",
                    \"text\": \"PR открыт: ${{ github.event.pull_request.html_url }} — ${{ github.event.pull_request.title }}\"
                  }]
                }]
              }
            }"

  # При мерже в dev — переводим в "Тестирование"
  dev-to-qa:
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    steps:
      - name: Extract Jira tickets from commits
        id: tickets
        run: |
          TICKETS=$(echo "${{ github.event.commits[0].message }}" | grep -oP 'CCAS-\d+' | head -1)
          echo "ticket=$TICKETS" >> $GITHUB_OUTPUT

      - name: Move ticket to Тестирование
        if: steps.tickets.outputs.ticket != ''
        run: |
          TRANSITIONS=$(curl -s \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_TOKEN }}" \
            -H "Accept: application/json" \
            "https://cccasess.atlassian.net/rest/api/3/issue/${{ steps.tickets.outputs.ticket }}/transitions")
          TRANSITION_ID=$(echo "$TRANSITIONS" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for t in data.get('transitions', []):
              if 'тест' in t['name'].lower() or 'qa' in t['name'].lower():
                  print(t['id'])
                  break
          ")
          if [ -n "$TRANSITION_ID" ]; then
            curl -s -X POST \
              -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_TOKEN }}" \
              -H "Content-Type: application/json" \
              "https://cccasess.atlassian.net/rest/api/3/issue/${{ steps.tickets.outputs.ticket }}/transitions" \
              -d "{\"transition\": {\"id\": \"$TRANSITION_ID\"}}"
            echo "Moved ${{ steps.tickets.outputs.ticket }} to Тестирование"
          fi

  # При мерже в main — переводим в "Готово"
  main-to-done:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Extract Jira ticket from commit
        id: ticket
        run: |
          TICKET=$(echo "${{ github.event.commits[0].message }}" | grep -oP 'CCAS-\d+' | head -1)
          echo "ticket=$TICKET" >> $GITHUB_OUTPUT

      - name: Move ticket to Готово
        if: steps.ticket.outputs.ticket != ''
        run: |
          TRANSITIONS=$(curl -s \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_TOKEN }}" \
            -H "Accept: application/json" \
            "https://cccasess.atlassian.net/rest/api/3/issue/${{ steps.ticket.outputs.ticket }}/transitions")
          TRANSITION_ID=$(echo "$TRANSITIONS" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for t in data.get('transitions', []):
              if 'готов' in t['name'].lower() or 'done' in t['name'].lower():
                  print(t['id'])
                  break
          ")
          if [ -n "$TRANSITION_ID" ]; then
            curl -s -X POST \
              -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_TOKEN }}" \
              -H "Content-Type: application/json" \
              "https://cccasess.atlassian.net/rest/api/3/issue/${{ steps.ticket.outputs.ticket }}/transitions" \
              -d "{\"transition\": {\"id\": \"$TRANSITION_ID\"}}"
            echo "Moved ${{ steps.ticket.outputs.ticket }} to Готово"
          fi
